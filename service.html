<head>
    <title>Timer</title>
    <meta charset="utf-8">
    <link href="../base1/cockpit.css" type="text/css" rel="stylesheet">
    <script src="../base1/patterns.js"></script>
    <script src="../base1/cockpit.js"></script>
    <script src="../base1/jquery.js"></script>
    <script src="../base1/mustache.js"></script>
    <script src="../system/service.js"></script>
    <link rel="stylesheet" type="text/css" href="../base1/patternfly.css">
    <link rel="stylesheet" type="text/css" href="../base1/patternfly-additions.css">
</head>
<body>
  <br>
<div class="container-fluid">
  <div id="target">
    <div class="spinner"></div>
  </div>
</div>

<script id="services-units-tmpl" type="x-template/mustache">
    <div class="panel panel-default">
      <div class="panel-heading">
        <span class="pull-right">
          <button id="create-timer"  data-toggle="modal" data-target="#myModal" class="btn btn-primary fa fa-plus"></button>
        </span>
        <span translatable="yes"><b>{{heading}}</b></span>
      </div>
      <table class="table table-hover panel-body">
        <tr>
          <td><h4><b>Description</b></h4></td>
          <td><h4><b>Id</b></h4></td>
          <td><h4><b>Next run</b></h4></td>
          <td><h4><b>State</b></h4></td>
        </tr>
        {{ #units }}
        <tr data-goto-unit="{{Id}}">
          <td class="service-unit-description">{{Description}}</td>
          <td>{{Id}}</td>
          <td>{{realtime_elapse}}{{monotonic_elapse}}</td>
          <td>{{ActiveState}} ({{SubState}})</td>
        </tr>
        {{ /units }}
      </table>
  </div>
</script>

<div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h4 class="modal-title" id="myModalLabel">Create Timers</h4>
      </div>
      <div class="modal-body">
        <form class="form-horizontal">
          <div class="form-group">
            <label class="col-sm-3 control-label" for="textInput-modal-markup">Service File name</label>
            <div class="col-sm-9">
              <input type="text" id="textInput-modal-markup" class="form-control"></div>
          </div>
          <div class="form-group">
            <label class="col-sm-3 control-label" for="textInput2-modal-markup">Desciption</label>
            <div class="col-sm-9">
              <input type="text" id="textInput2-modal-markup" class="form-control"></div>
          </div>
          <div class="form-group">
            <label class="col-sm-3 control-label" for="textInput3-modal-markup">Command</label>
            <div class="col-sm-9">
              <input type="text" id="textInput3-modal-markup" class="form-control">
            </div>
          </div>
          <div class="form-group">
            <label class="col-sm-3 control-label" for="textInput3-modal-markup">Run</label>
            <div class="col-sm-9">
              <div class="btn-group bootstrap-select dropdown form-control" id="control-2">
                <button class="btn btn-default dropdown-toggle" type="button" data-toggle="dropdown" aria-expanded="false">
                  <span class="pull-left" translatable="yes">After system boot</span>
                  <span class="caret"></span>
                </button>
                <ul class="dropdown-menu">
                  <li value="1"><a>After system boot</a></li>
                  <li value="2"><a>At specific time</a></li>
                </ul>
              </div>
            </div>
          </div>
          <div class="form-group" id="boot">
            <label class="col-sm-3 control-label" for="textInput3-modal-markup">At</label>
            <div class="col-sm-3">
              <input type="text" id="textInput3-modal-markup" class="form-control">
            </div>
            <div class="col-sm-6">
              <div class="btn-group bootstrap-select dropdown form-control" id="control-3">
                <button class="btn btn-default dropdown-toggle" type="button" data-toggle="dropdown" aria-expanded="false">
                  <span class="pull-left" translatable="yes">Seconds</span>
                  <span class="caret"></span>
                </button>
                <ul class="dropdown-menu">
                  <li value="1"><a>Seconds</a></li>
                  <li value="2"><a>Minutes</a></li>
                  <li value="3"><a>Hours</a></li>
                  <li value="4"><a>Weeks</a></li>
                </ul>
              </div>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary">Save</button>
      </div>
    </div>
  </div>
</div>


<script type="text/javascript">
//patterns.js L75
$("#control-2").on("click", "[value]", function(ev) {
    var target = $(this);
    $("span", ev.delegateTarget).first().text(target.text());
    console.log("value: ", target.attr("value"));
    timerproperties(target.attr("value"));
});
$("#control-3").on("click", "[value]", function(ev) {
    var target = $(this);
    $("span", ev.delegateTarget).first().text(target.text());
    console.log("value: ", target.attr("value"));
});

var timerproperties = function(value){
  if (value == 1) {
    $("#boot").show();
  }
  else if (value == 2) {
    $("#boot").hide();
  }

}
units_by_path = { };
//init.js L155
function get_unit(path) {
    var unit = units_by_path[path];
    if (!unit) {
        unit = { aliases: [ ], path: path };
        units_by_path[path] = unit;
    }
    return unit;
}
//init.js L287
function record_unit_state(state) {
  var unit = get_unit(state[6]);
  unit.Id = state[0];
  unit.Description = state[1];
  unit.LoadState = state[2];
  unit.ActiveState = state[3];
  unit.SubState = state[4];
  unit.path = state[6];
  GetAll(unit);
}
//service.js L79
function wait_valid(proxy, callback) {
  proxy.wait(function() {
  if (proxy.valid)
    callback(proxy);
  });
};
//init.js L243
var units_template = $("#services-units-tmpl").html();
Mustache.parse(units_template);

function fill_table(parent, heading, units) {
  var text = Mustache.render(units_template, {
    heading: heading,
    units: units
  });
  parent.html(text);
};

// Get's connected to timer d-bus and get all its property values.
function GetAll(unit) {
  if (unit) {
    var systemd_client = cockpit.dbus("org.freedesktop.systemd1", { superuser: "try" });
    var systemd_timer = systemd_client.proxy("org.freedesktop.systemd1.Timer", unit.path);
    wait_valid(systemd_timer,display);
  }
};

function display(systemd_timer){
    // console.log(systemd_timer.valid);
    if (systemd_timer.NextElapseUSecRealtime != 0){
      console.log(systemd_timer.NextElapseUSecRealtime);
      var date = new Date(systemd_timer.NextElapseUSecRealtime/1000);
      units_by_path[systemd_timer.path].realtime_elapse = date.toString();
      console.log(units_by_path[systemd_timer.path].realtime_elapse);
    }
    if (systemd_timer.NextElapseUSecMonotonic != 0){
      console.log("MONO "+systemd_timer.NextElapseUSecMonotonic);
      var d = new Date();
      var date = new Date(systemd_timer.NextElapseUSecMonotonic/1000 + (d.getTime()-d.getMilliseconds()));
      units_by_path[systemd_timer.path].monotonic_elapse = date.toString();
      console.log(units_by_path[systemd_timer.path].monotonic_elapse);
    }
};

operation = function (systemd_manager) {
  var units = [ ];
  function render () {
    for(var key in units_by_path) {
      $.when( GetAll(units_by_path[key]) ).then(
        function(){
          units.push(units_by_path[key]);})
        // GetAll(units_by_path[key]);
        // units.push(units_by_path[key]);
        console.log("SD");
    }
    fill_table($('#target'), "Timers", units);  
  }
  
  function failure (error){
    console.log(error);
  };

  // function r (result){
  //   var substring = "timer";
  //   for (var i = result.length - 1; i >= 0; i--) {
  //     if ( result[i][0].slice(-5) == substring )
  //      console.log(result[i][0]); 
  //   };

  // };

  function s (result) {
    var dfd = $.Deferred();
    if (true) {
      var substring = "timer";
      for (var i = 0; i < result.length; i++) {
        if ( result[i][0].slice(-5) == substring ) {
          // console.log(result[i][0]);
          record_unit_state(result[i]);
        }
      }
      dfd.resolve();
    }  
    return dfd.promise();
  }

  systemd_manager.ListUnits().
  fail(failure).
  done(
    function(result){  
      $.when(s(result)).then(
          function(){
            setTimeout(render, 500);
          }
    )});

  // systemd_manager.ListUnitFiles().
  // fail(failure).
  // done(r);
  // setTimeout(render, 500);
};

</script>
<script type="text/javascript">
var systemd_client = cockpit.dbus("org.freedesktop.systemd1", { superuser: "try" });
var systemd_manager = systemd_client.proxy("org.freedesktop.systemd1.Manager","/org/freedesktop/systemd1");
wait_valid(systemd_manager,operation);
console.log(units_by_path);

</script>
</body>