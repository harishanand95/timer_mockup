<head>
    <title>Timer</title>
    <meta charset="utf-8">
    <link href="../base1/cockpit.css" type="text/css" rel="stylesheet">
    <script src="../base1/patterns.js"></script>
    <script src="../base1/cockpit.js"></script>
    <script src="../base1/jquery.js"></script>
    <script src="../base1/mustache.js"></script>
    <script src="../system/service.js"></script>
    <link rel="stylesheet" type="text/css" href="../base1/patternfly.css">
    <link rel="stylesheet" type="text/css" href="../base1/patternfly-additions.css">
</head>
<body>
  <br>
<div class="container-fluid">
  <div id="target">
    <div class="spinner"></div>
  </div>
</div>

<script id="services-units-tmpl" type="x-template/mustache">
    <div class="panel panel-default">
      <div class="panel-heading">
        <span class="pull-right">
          <button id="create-timer" data-toggle="modal" data-target="#myModal" class="btn btn-primary fa fa-plus"></button>
        </span>
        <span translatable="yes"><b>{{heading}}</b></span>
      </div>
      <table class="table table-hover panel-body">
        <tr>
          <td><h4><b>Description</b></h4></td>
          <td><h4><b>Id</b></h4></td>
          <td><h4><b>Next run</b></h4></td>
          <td><h4><b>Last run</b></h4></td>
          <td><h4><b>State</b></h4></td>
        </tr>
        {{ #units }}
        <tr data-goto-unit="{{Id}}">
          <td class="service-unit-description">{{Description}}</td>
          <td>{{Id}}</td>
          <td>{{next_run}}</td>
          <td>{{last_run}}</td>
          <td>{{ActiveState}} ({{SubState}})</td>
        </tr>
        {{ /units }}
      </table>
  </div>
</script>

<div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h4 class="modal-title" id="myModalLabel">Create Timers</h4>
      </div>
      <div class="modal-body">
        <form class="form-horizontal">
          <div class="form-group">
            <label class="col-sm-3 control-label" for="textInput-modal-markup">Service File name</label>
            <div class="col-sm-9">
              <input type="text" id="textInput-modal-markup" class="form-control"></div>
          </div>
          <div class="form-group">
            <label class="col-sm-3 control-label" for="textInput2-modal-markup">Desciption</label>
            <div class="col-sm-9">
              <input type="text" id="textInput2-modal-markup" class="form-control"></div>
          </div>
          <div class="form-group">
            <label class="col-sm-3 control-label" for="textInput3-modal-markup">Command</label>
            <div class="col-sm-9">
              <input type="text" id="textInput3-modal-markup" class="form-control">
            </div>
          </div>
          <div class="form-group">
            <label class="col-sm-3 control-label" for="textInput3-modal-markup">Run</label>
            <div class="col-sm-9">
              <div class="btn-group bootstrap-select dropdown form-control" id="control-2">
                <button class="btn btn-default dropdown-toggle" type="button" data-toggle="dropdown" aria-expanded="false">
                  <span class="pull-left" translatable="yes">After system boot</span>
                  <span class="caret"></span>
                </button>
                <ul class="dropdown-menu">
                  <li value="1"><a>After system boot</a></li>
                  <li value="2"><a>At specific time</a></li>
                </ul>
              </div>
            </div>
          </div>
          <div class="form-group" id="boot">
            <label class="col-sm-3 control-label" for="textInput3-modal-markup">At</label>
            <div class="col-sm-3">
              <input type="text" id="textInput3-modal-markup" class="form-control">
            </div>
            <div class="col-sm-6">
              <div class="btn-group bootstrap-select dropdown form-control" id="control-3">
                <button class="btn btn-default dropdown-toggle" type="button" data-toggle="dropdown" aria-expanded="false">
                  <span class="pull-left" translatable="yes">Seconds</span>
                  <span class="caret"></span>
                </button>
                <ul class="dropdown-menu">
                  <li value="1"><a>Seconds</a></li>
                  <li value="2"><a>Minutes</a></li>
                  <li value="3"><a>Hours</a></li>
                  <li value="4"><a>Weeks</a></li>
                </ul>
              </div>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary">Save</button>
      </div>
    </div>
  </div>
</div>


<script type="text/javascript">
//patterns.js L75
$("#control-2").on("click", "[value]", function(ev) {
    var target = $(this);
    $("span", ev.delegateTarget).first().text(target.text());
    console.log("value: ", target.attr("value"));
    timerproperties(target.attr("value"));
});
$("#control-3").on("click", "[value]", function(ev) {
    var target = $(this);
    $("span", ev.delegateTarget).first().text(target.text());
    console.log("value: ", target.attr("value"));
});
var timerproperties = function(value){
  if (value == 1) {
    $("#boot").show();
  }
  else if (value == 2) {
    $("#boot").hide();
  }
}
units_by_path = { };

/* A JS version of time conversion used in systemd
* Available C version at systemd/src/basic/time-util.c
* Input t = real time microsecond (1463509800000000)
*/
function format_timestamp_relative(t) {
    var MSEC_PER_SEC = 1000;
    var USEC_PER_SEC = 1000000;
    var USEC_PER_MSEC = 1000;
    var USEC_INFINITY =-1;

    var USEC_PER_MINUTE = 60*USEC_PER_SEC;
    var USEC_PER_HOUR = 60*USEC_PER_MINUTE;
    var USEC_PER_DAY = 24*USEC_PER_HOUR;
    var USEC_PER_WEEK = 7*USEC_PER_DAY;
    var USEC_PER_MONTH = 2629800*USEC_PER_SEC;
    var USEC_PER_YEAR = 31557600*USEC_PER_SEC;

  var s = "";
    var n, d; 

    if (t <= 0 || t == USEC_INFINITY)
            return ;
    //subtracting the milliseconds in order to get a whole number instead of a fraction
    var date = new Date();
    n = (date.getTime()-date.getMilliseconds()) * 1000;
    if (n > t) {
            d = n - t;
            s = "ago";
    } else {
            d = t - n;
            s = "left";
    }
    if (d >= USEC_PER_YEAR)
        return String(Math.floor( d / USEC_PER_YEAR )+ " years " + Math.floor( (d % USEC_PER_YEAR) / USEC_PER_MONTH ) + " months " + s);
    else if (d >= USEC_PER_MONTH)
            return String(Math.floor( d / USEC_PER_MONTH )+ " months " + Math.floor( (d % USEC_PER_MONTH) / USEC_PER_DAY )+ " days " + s);
    else if (d >= USEC_PER_WEEK)
            return String(Math.floor( d / USEC_PER_WEEK ) + " weeks "+ Math.floor( (d % USEC_PER_WEEK) / USEC_PER_DAY ) +" days " + s);
    else if (d >= 2*USEC_PER_DAY)
            return String(Math.floor( d / USEC_PER_DAY ) +" days " +s);
    else if (d >= 25*USEC_PER_HOUR)
            return String("1 day "+ Math.floor( (d - USEC_PER_DAY) / USEC_PER_HOUR ) +"h " +s);
    else if (d >= 6*USEC_PER_HOUR)
            return String( Math.floor( d / USEC_PER_HOUR ) +"h " + s);
    else if (d >= USEC_PER_HOUR)
            return String( Math.floor( d / USEC_PER_HOUR ) +"h "+ Math.floor( (d % USEC_PER_HOUR) / USEC_PER_MINUTE ) +"min " + s);
    else if (d >= 5*USEC_PER_MINUTE)
            return String( Math.floor( d / USEC_PER_MINUTE ) +"min " + s);
    else if (d >= USEC_PER_MINUTE)
            return String( Math.floor( d / USEC_PER_MINUTE ) +"min "+ Math.floor( (d % USEC_PER_MINUTE) / USEC_PER_SEC )+"s "+ s);
    else if (d >= USEC_PER_SEC)
            return String( Math.floor( d / USEC_PER_SEC ) +"s " + s);
    else if (d >= USEC_PER_MSEC)
            return String( Math.floor( d / USEC_PER_MSEC ) +"ms " + s);
    else if (d > 0)
            return String(Math.floor(d) +"us " + s);
    else
            return String("now");
    return;
}
//init.js L155
function get_unit(path) {
    var unit = units_by_path[path];
    if (!unit) {
        unit = { aliases: [ ], path: path };
        units_by_path[path] = unit;
    }
    return unit;
};
//init.js L287
function record_unit_state(state) {
  var unit = get_unit(state[6]);
  unit.Id = state[0];
  unit.Description = state[1];
  unit.LoadState = state[2];
  unit.ActiveState = state[3];
  unit.SubState = state[4];
  unit.path = state[6];
};
//service.js L79
function wait_valid(proxy, callback, args) {
  proxy.wait(function() {
  if (proxy.valid)
    callback(proxy, args);
  });
};
//init.js L243
var units_template = $("#services-units-tmpl").html();
Mustache.parse(units_template);
function fill_table(parent, heading, units) {
  var text = Mustache.render(units_template, {
    heading: heading,
    units: units
  });
  parent.html(text);
};

function add_last_next_times(timer, manager) {
  if (timer.NextElapseUSecMonotonic > 0)
    var time_left_for_next_run = manager.GeneratorsStartTimestamp + timer.NextElapseUSecMonotonic;
  else
    var time_left_for_next_run = timer.NextElapseUSecRealtime;
  unit = get_unit(timer.path);
  unit.next_run = format_timestamp_relative(time_left_for_next_run);
  unit.last_run = format_timestamp_relative(timer.LastTriggerUSec);
};

operation = function (systemd_manager) {
  var units = [ ];
  
  function render () {
    for(var key in units_by_path) {
      console.log(key);
      add_timings(key);
      units.push(units_by_path[key])
    }
    setTimeout(function(){
      fill_table($('#target'), "Timers", units);
    }, 500);  
  };

  function add_timings(key) {
    var systemd_client = cockpit.dbus("org.freedesktop.systemd1", { superuser: "try" });
    var systemd_timer = systemd_client.proxy("org.freedesktop.systemd1.Timer", key);
    wait_valid(systemd_timer, add_last_next_times, systemd_manager);
  };

  function failure (error){
    console.log(error);
  };

  function s (result) {
    var dfd = $.Deferred();
    if (true) {
      var substring = "timer";
      for (var i = 0; i < result.length; i++) {
        if ( result[i][0].slice(-5) == substring ) {
          record_unit_state(result[i]);
        }
      }
      dfd.resolve();
    }  
    return dfd.promise();
  };

  systemd_manager.ListUnits().
  fail(failure).
  done(
    function(result){  
      $.when(s(result)).then(
          function(){
            setTimeout(render, 500);
          }
    )});
};

var systemd_client = cockpit.dbus("org.freedesktop.systemd1", { superuser: "try" });
var systemd_manager = systemd_client.proxy("org.freedesktop.systemd1.Manager","/org/freedesktop/systemd1");
wait_valid(systemd_manager,operation);
</script>
</body>